<div class="dashboard-container">
    <h1 class="page-title">Efficiency Dashboard</h1>

    <!-- Live Status Indicator -->
    <div class="live-status">
        <span class="live-dot"></span>
        <span id="last-update">Updating...</span>
    </div>

    <div class="home-sections">
        <!-- Pool Performance Hero Card -->
        <div class="home-section hero-card">
            <div class="hero-header">
                <div class="hero-title-section">
                    <h2>Pool Performance</h2>
                    <span class="live-indicator">
                        <span class="live-dot"></span>
                        <span id="worker-status">loading...</span>
                    </span>
                </div>
            </div>
            <div class="hero-stats">
                <div class="hero-stat primary">
                    <div class="hero-stat-value" id="pool-hashrate">-</div>
                    <div class="hero-stat-label">Pool Hashrate</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-value" id="active-workers">-</div>
                    <div class="hero-stat-label">Workers</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-value" id="active-users">-</div>
                    <div class="hero-stat-label">Users</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-value" id="network-share">-</div>
                    <div class="hero-stat-label">Network Share</div>
                </div>
            </div>
            <div class="hero-details">
                <div class="hero-detail-row">
                    <div class="hero-detail">
                        <span class="detail-label">Best Difficulty</span>
                        <span class="detail-value highlight" id="best-diff">-</span>
                    </div>
                    <div class="hero-detail">
                        <span class="detail-label">Network Hashrate</span>
                        <span class="detail-value" id="network-hashrate">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Block Mining Potential Card -->
        <div class="home-section hero-card">
            <div class="hero-header">
                <div class="hero-title-section">
                    <h2>Block Mining Potential</h2>
                </div>
            </div>
            <div class="hero-stats">
                <div class="hero-stat primary">
                    <div class="hero-stat-value" id="expected-time">-</div>
                    <div class="hero-stat-label">Expected Block Time</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-value" id="daily-probability">-</div>
                    <div class="hero-stat-label">Daily Chance</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-value" id="block-reward">-</div>
                    <div class="hero-stat-label">Block Reward</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-value" id="daily-revenue">-</div>
                    <div class="hero-stat-label">Expected Daily</div>
                </div>
            </div>
            <div class="hero-details">
                <div class="hero-detail-row">
                    <div class="hero-detail">
                        <span class="detail-label">Block Subsidy</span>
                        <span class="detail-value">3.125 BTC</span>
                    </div>
                    <div class="hero-detail">
                        <span class="detail-label">Est. Fees</span>
                        <span class="detail-value" id="block-fees">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Efficiency & Fees Card -->
        <div class="home-section fee-rates">
            <h3>Share Efficiency</h3>
            <div class="fee-grid">
                <div class="fee-item">
                    <span class="fee-label">Shares/sec</span>
                    <span class="fee-value" id="shares-per-sec">-</span>
                </div>
                <div class="fee-item">
                    <span class="fee-label">Accepted Diff</span>
                    <span class="fee-value success" id="accepted-diff">-</span>
                </div>
                <div class="fee-item">
                    <span class="fee-label">Reject Rate</span>
                    <span class="fee-value" id="reject-rate">-</span>
                </div>
            </div>
            <h4 style="margin-top: 20px; margin-bottom: 10px; text-align: center;">Fee Rates (sat/vB)</h4>
            <div class="fee-grid">
                <div class="fee-item highlight">
                    <span class="fee-label">High Priority</span>
                    <span class="fee-value" id="fee-fast">-</span>
                </div>
                <div class="fee-item">
                    <span class="fee-label">Medium</span>
                    <span class="fee-value" id="fee-medium">-</span>
                </div>
                <div class="fee-item">
                    <span class="fee-label">Economy</span>
                    <span class="fee-value" id="fee-economy">-</span>
                </div>
            </div>
        </div>
    </div>

    <div class="stats-actions">
        <a href="/" class="btn btn-secondary">Back to Home</a>
        <button class="btn btn-primary" onclick="refreshDashboard()">Refresh Now</button>
    </div>
</div>

<style>
.dashboard-container {
    max-width: 1200px;
    margin: 0 auto;
}

.live-status {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 30px;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.live-dot {
    width: 10px;
    height: 10px;
    background: #00c853;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
</style>

<script>
let refreshInterval;

document.addEventListener('DOMContentLoaded', function() {
    refreshDashboard();
    refreshInterval = setInterval(refreshDashboard, 10000);
});

async function refreshDashboard() {
    try {
        const res = await secureFetch('/api/efficiency');
        const { data } = await res.json();

        if (!data) return;

        // Pool Performance
        document.getElementById('pool-hashrate').textContent = data.poolHashrateFormatted;
        document.getElementById('active-workers').textContent = data.activeWorkers;
        document.getElementById('active-users').textContent = data.activeUsers;
        document.getElementById('network-share').textContent = data.networkShareFormatted;
        document.getElementById('best-diff').textContent = data.bestDifficultyFormatted;
        document.getElementById('network-hashrate').textContent = data.networkHashrateFormatted;
        document.getElementById('worker-status').textContent = data.activeWorkers + ' workers connected';

        // Block Mining Potential
        document.getElementById('expected-time').textContent = data.expectedBlockTimeFormatted;
        document.getElementById('daily-probability').textContent = data.dailyBlockProbabilityFormatted;
        document.getElementById('block-reward').textContent = data.blockReward.toFixed(3) + ' BTC';
        document.getElementById('daily-revenue').textContent = data.expectedDailyRevenueFormatted;
        document.getElementById('block-fees').textContent = data.estimatedBlockFeesFormatted;

        // Share Efficiency
        document.getElementById('shares-per-sec').textContent = data.sharesPerSecond.toFixed(2);
        document.getElementById('accepted-diff').textContent = formatDifficulty(data.diffSharesAccepted);
        document.getElementById('reject-rate').textContent = data.rejectRate;

        // Fee Market
        document.getElementById('fee-fast').textContent = data.currentFees.fastest;
        document.getElementById('fee-medium').textContent = data.currentFees.hour;
        document.getElementById('fee-economy').textContent = data.currentFees.economy;

        // Update timestamp
        document.getElementById('last-update').textContent =
            'Updated ' + new Date().toLocaleTimeString();

    } catch (err) {
        console.error('Dashboard refresh failed:', err);
    }
}

function formatDifficulty(diff) {
    if (!diff) return '0';
    if (diff >= 1e15) return (diff / 1e15).toFixed(2) + ' P';
    if (diff >= 1e12) return (diff / 1e12).toFixed(2) + ' T';
    if (diff >= 1e9) return (diff / 1e9).toFixed(2) + ' G';
    if (diff >= 1e6) return (diff / 1e6).toFixed(2) + ' M';
    if (diff >= 1e3) return (diff / 1e3).toFixed(2) + ' K';
    return diff.toFixed(2);
}
</script>

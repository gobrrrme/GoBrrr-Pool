<div class="pool-container">
    <h1 class="page-title">Pool Statistics</h1>
    <% if (pool) { %>

    <div class="pool-sections">

        <!-- Pool & Network Hero Card (full width) -->
        <div class="home-section hero-card">
            <div class="hero-header">
                <div class="hero-title-section">
                    <h2>Pool & Network</h2>
                    <span class="live-indicator">
                        <span class="live-dot"></span>
                        <%= pool.workers %> workers connected
                    </span>
                </div>
            </div>
            <div class="hero-stats">
                <div class="hero-stat primary">
                    <div class="hero-stat-value"><%= formatHashrate(pool.hashrate) %></div>
                    <div class="hero-stat-label">Pool Hashrate</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-value"><%= pool.workers %></div>
                    <div class="hero-stat-label">Workers</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-value"><%= pool.users %></div>
                    <div class="hero-stat-label">Users</div>
                </div>
                <div class="hero-stat">
                    <div class="hero-stat-value"><%= formatHashrate(networkHashrate) %></div>
                    <div class="hero-stat-label">Network Hashrate</div>
                </div>
            </div>
            <div class="hero-details">
                <div class="hero-detail-row">
                    <div class="hero-detail">
                        <span class="detail-label">Best Ever Difficulty</span>
                        <span class="detail-value highlight"><%= formatDifficulty(pool.bestDiff) %></span>
                    </div>
                    <div class="hero-detail">
                        <span class="detail-label">Network Difficulty</span>
                        <span class="detail-value"><%= formatDifficulty(pool.networkDiff) %></span>
                    </div>
                    <div class="hero-detail">
                        <span class="detail-label">Network Share</span>
                        <span class="detail-value"><%= networkShare > 0 ? (networkShare >= 0.0001 ? networkShare.toFixed(6) + '%' : '< 0.0001%') : 'N/A' %></span>
                    </div>
                    <div class="hero-detail">
                        <span class="detail-label">Next Block</span>
                        <span class="detail-value"><%= pool.blockHeight || 'N/A' %></span>
                    </div>
                    <div class="hero-detail">
                        <span class="detail-label">Total Shares</span>
                        <span class="detail-value"><%= pool.shares.toLocaleString() %></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Two-column row: Block Potential + Share Performance -->
        <div class="pool-cols-2">

            <!-- Block Potential (populated via /api/efficiency) -->
            <div class="home-section hero-card compact-card">
                <div class="hero-header">
                    <div class="hero-title-section">
                        <h2>Block Potential</h2>
                    </div>
                </div>
                <div class="hero-stats">
                    <div class="hero-stat primary">
                        <div class="hero-stat-value" id="expected-time">Calculating...</div>
                        <div class="hero-stat-label">Expected Block Time</div>
                    </div>
                    <div class="hero-stat">
                        <div class="hero-stat-value" id="daily-probability">-</div>
                        <div class="hero-stat-label">Daily Chance</div>
                    </div>
                    <div class="hero-stat">
                        <div class="hero-stat-value" id="block-reward">-</div>
                        <div class="hero-stat-label">Block Reward</div>
                    </div>
                    <div class="hero-stat">
                        <div class="hero-stat-value" id="daily-revenue">-</div>
                        <div class="hero-stat-label">Expected Daily</div>
                    </div>
                </div>
                <div class="hero-details">
                    <div class="hero-detail-row">
                        <div class="hero-detail">
                            <span class="detail-label">Block Subsidy</span>
                            <span class="detail-value" id="block-subsidy">-</span>
                        </div>
                        <div class="hero-detail">
                            <span class="detail-label">Est. Fees</span>
                            <span class="detail-value" id="block-fees">-</span>
                        </div>
                    </div>
                    <!-- Fee Rates -->
                    <div class="fee-rates-mini">
                        <span class="fee-mini-label">sat/vB:</span>
                        <span class="fee-mini-item">High <strong id="fee-fast">-</strong></span>
                        <span class="fee-mini-item">Mid <strong id="fee-medium">-</strong></span>
                        <span class="fee-mini-item">Low <strong id="fee-economy">-</strong></span>
                    </div>
                </div>
            </div>

            <!-- Share Performance + Pool Status -->
            <div class="home-section fee-rates compact-card">
                <h3>Share Performance</h3>
                <div class="fee-grid">
                    <div class="fee-item">
                        <span class="fee-label">Shares/sec</span>
                        <span class="fee-value"><%= pool.sps1.toFixed(2) %></span>
                    </div>
                    <div class="fee-item">
                        <span class="fee-label">Accepted Diff</span>
                        <span class="fee-value success"><%= formatDifficulty(pool.accepted) %></span>
                    </div>
                    <div class="fee-item">
                        <span class="fee-label">Rejected Diff</span>
                        <span class="fee-value"><%= formatDifficulty(pool.rejected) %></span>
                    </div>
                    <div class="fee-item">
                        <span class="fee-label">Reject Rate</span>
                        <span class="fee-value <%= pool.rejected > 0 ? 'warning' : 'success' %>"><%= pool.accepted > 0 ? ((pool.rejected / (pool.accepted + pool.rejected)) * 100).toFixed(2) + '%' : '0%' %></span>
                    </div>
                </div>
                <h3 style="margin-top: 18px;">Pool Status</h3>
                <div class="fee-grid">
                    <div class="fee-item">
                        <span class="fee-label">Uptime</span>
                        <span class="fee-value"><%= pool.uptime > 0 ? timeAgo(Math.floor(Date.now()/1000) - pool.uptime).replace(' ago', '') : 'N/A' %></span>
                    </div>
                    <div class="fee-item">
                        <span class="fee-label">Started</span>
                        <span class="fee-value"><%= pool.startTime > 1577836800 ? timeAgo(pool.startTime) : 'N/A' %></span>
                    </div>
                    <div class="fee-item">
                        <span class="fee-label">Last Update</span>
                        <span class="fee-value"><%= pool.lastUpdate > 1577836800 ? timeAgo(pool.lastUpdate) : 'Just now' %></span>
                    </div>
                    <div class="fee-item">
                        <span class="fee-label">Connections</span>
                        <span class="fee-value"><%= pool.connections || 'N/A' %></span>
                    </div>
                </div>
            </div>

        </div>

        <!-- Hashrate Averages (compact) -->
        <div class="home-section fee-rates compact-card">
            <h3>Hashrate Averages</h3>
            <div class="fee-grid hashrate-avg-grid">
                <div class="fee-item">
                    <span class="fee-label">1m</span>
                    <span class="fee-value"><%= formatHashrate(pool.hashrate1m) %></span>
                </div>
                <div class="fee-item">
                    <span class="fee-label">5m</span>
                    <span class="fee-value"><%= formatHashrate(pool.hashrate5m) %></span>
                </div>
                <div class="fee-item">
                    <span class="fee-label">15m</span>
                    <span class="fee-value"><%= formatHashrate(pool.hashrate15m) %></span>
                </div>
                <div class="fee-item">
                    <span class="fee-label">1h</span>
                    <span class="fee-value"><%= formatHashrate(pool.hashrate1h) %></span>
                </div>
                <div class="fee-item">
                    <span class="fee-label">6h</span>
                    <span class="fee-value"><%= formatHashrate(pool.hashrate6h) %></span>
                </div>
                <div class="fee-item">
                    <span class="fee-label">24h</span>
                    <span class="fee-value"><%= formatHashrate(pool.hashrate1d) %></span>
                </div>
                <div class="fee-item">
                    <span class="fee-label">7d</span>
                    <span class="fee-value"><%= formatHashrate(pool.hashrate7d) %></span>
                </div>
            </div>
        </div>

        <% if (minerTypes && minerTypes.length > 0) { %>
        <!-- Connected Miner Types -->
        <div class="home-section fee-rates compact-card">
            <h3>Connected Miner Types</h3>
            <div class="miner-types-grid">
                <% minerTypes.forEach(function(m) { %>
                <div class="miner-type-card">
                    <div class="miner-type-name"><%= m.name %></div>
                    <div class="miner-type-count"><%= m.count %></div>
                </div>
                <% }); %>
            </div>
        </div>
        <% } %>

        <!-- Hashrate Chart -->
        <div class="home-section hashrate-section compact-card">
            <h3>Pool Hashrate</h3>
            <div class="chart-container">
                <% if (pool.hashrate1m > 0 || pool.hashrate5m > 0 || pool.hashrate1h > 0 || pool.hashrate1d > 0) { %>
                <canvas id="pool-hashrate-chart"></canvas>
                <% } else { %>
                <div class="no-chart-data">
                    <p>No hashrate data available yet.</p>
                    <p class="hint">Data will appear when miners are connected.</p>
                </div>
                <% } %>
            </div>
        </div>

    </div>

    <% } else { %>
    <div class="no-data">
        <p>Unable to load pool statistics.</p>
        <p>The pool daemon may not be running.</p>
    </div>
    <% } %>

    <div class="stats-actions">
        <a href="/" class="btn btn-secondary">Back to Home</a>
        <button class="btn btn-primary" onclick="location.reload()">Refresh</button>
    </div>
</div>

<style>
.pool-sections {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
}

.pool-cols-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.compact-card {
    padding: 20px 24px !important;
}

.hashrate-avg-grid {
    grid-template-columns: repeat(7, 1fr) !important;
}

.fee-rates-mini {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid rgba(255,255,255,0.08);
    font-size: 0.85rem;
    color: #c4c4c4;
    flex-wrap: wrap;
}

.fee-mini-label {
    color: #888;
}

.fee-mini-item {
    color: #c4c4c4;
}

.fee-mini-item strong {
    color: #ff931c;
}

@media (max-width: 900px) {
    .pool-cols-2 {
        grid-template-columns: 1fr;
    }

    .hashrate-avg-grid {
        grid-template-columns: repeat(4, 1fr) !important;
    }
}

@media (max-width: 600px) {
    .compact-card {
        padding: 14px 16px !important;
    }

    .hashrate-avg-grid {
        grid-template-columns: repeat(3, 1fr) !important;
    }
}
</style>

<script>
    <% if (pool) { %>
    document.addEventListener('DOMContentLoaded', function() {
        <% if (pool.hashrate1m > 0 || pool.hashrate5m > 0 || pool.hashrate1h > 0 || pool.hashrate1d > 0) { %>
        if (typeof initHashrateChart === 'function') {
            initHashrateChart([
                { label: '7d', value: <%= pool.hashrate7d || 0 %> },
                { label: '24h', value: <%= pool.hashrate1d || 0 %> },
                { label: '6h', value: <%= pool.hashrate6h || 0 %> },
                { label: '1h', value: <%= pool.hashrate1h || 0 %> },
                { label: '15m', value: <%= pool.hashrate15m || 0 %> },
                { label: '5m', value: <%= pool.hashrate5m || 0 %> },
                { label: '1m', value: <%= pool.hashrate1m || 0 %> }
            ], 'pool-hashrate-chart');
        }
        <% } %>

        // Load efficiency data for Block Potential card
        loadEfficiencyData();
        setInterval(loadEfficiencyData, 30000);
    });

    async function loadEfficiencyData() {
        try {
            const res = await secureFetch('/api/efficiency');
            const { data } = await res.json();
            if (!data) return;

            const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };

            set('expected-time', data.expectedBlockTimeFormatted);
            set('daily-probability', data.dailyBlockProbabilityFormatted);
            set('block-reward', data.blockReward.toFixed(3) + ' BTC');
            set('daily-revenue', data.expectedDailyRevenueFormatted);
            set('block-subsidy', data.blockReward ? (data.blockReward - (data.estimatedBlockFees || 0)).toFixed(3) + ' BTC' : '-');
            set('block-fees', data.estimatedBlockFeesFormatted);
            set('fee-fast', data.currentFees.fastest);
            set('fee-medium', data.currentFees.hour);
            set('fee-economy', data.currentFees.economy);
        } catch (err) {
            console.error('Failed to load efficiency data:', err);
        }
    }
    <% } %>
</script>

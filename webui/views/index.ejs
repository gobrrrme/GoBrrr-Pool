<div class="home-container">
    <!-- Top Row: Worker Lookup + Pool Stats Side by Side -->
    <div class="top-cards-row">
        <!-- Worker Lookup Card -->
        <div class="top-card lookup-card">
            <div class="pool-section-label">Stratum Connection</div>
            <div class="stratum-connect-block">
                <div class="stratum-row">
                    <span class="stratum-key">host</span>
                    <span class="stratum-val" id="stratum-host">loading...</span>
                    <span class="stratum-port">port&nbsp;<%= stratumPort %></span>
                </div>
                <div class="stratum-row">
                    <span class="stratum-key">user</span>
                    <span class="stratum-val stratum-hint">BTC_address.workername</span>
                </div>
                <div class="stratum-row">
                    <span class="stratum-key">pass</span>
                    <span class="stratum-val"><span class="stratum-hint">x</span><span class="stratum-sep">or</span><span class="stratum-hint">d=XXXX</span><span class="stratum-desc">to set a fixed difficulty</span></span>
                </div>
            </div>
            <div class="stratum-note">Worker names are visible on the Leaderboard</div>
            <div class="pool-section-label" style="margin-top: 20px;">Worker Lookup</div>
            <form class="lookup-form" id="address-form">
                <div class="input-group">
                    <div class="lookup-field" id="lookup-field" onclick="document.getElementById('btc-address').focus()">
                        <div class="lookup-chips" id="lookup-chips"></div>
                        <input
                            type="text"
                            name="address"
                            id="btc-address"
                            placeholder="1..., 3..., or bc1..."
                            autocomplete="off"
                        >
                    </div>
                    <button type="submit" class="btn btn-primary">Lookup</button>
                </div>
            </form>
        </div>

        <!-- Pool Statistics Card -->
        <div class="top-card pool-card">
            <div class="pool-section-label">Pool Statistics</div>
            <div class="pool-stats-grid">
                <div class="pool-stat">
                    <div class="pool-stat-value" id="pool-hashrate">-</div>
                    <div class="pool-stat-label">Pool Hashrate</div>
                </div>
                <div class="pool-stat">
                    <div class="pool-stat-value" id="pool-workers">-</div>
                    <div class="pool-stat-label">Workers</div>
                </div>
                <div class="pool-stat">
                    <div class="pool-stat-value" id="pool-users">-</div>
                    <div class="pool-stat-label">Users</div>
                </div>
                <div class="pool-stat">
                    <div class="pool-stat-value" id="pool-best-diff">-</div>
                    <div class="pool-stat-label">Best Ever Difficulty</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sortable sections wrapper -->
    <div class="home-sections">
        <!-- Node Info Card -->
        <div class="home-section fee-rates" id="node-info-section">
            <div class="pool-section-label">Bitcoin Node</div>
            <div class="node-info-grid">
                <div class="node-info-item">
                    <span class="fee-label">Bitcoin Core</span>
                    <span class="fee-value" id="node-version">—</span>
                </div>
                <div class="node-info-item">
                    <span class="fee-label">Client</span>
                    <span class="fee-value" id="node-subversion">—</span>
                </div>
                <div class="node-info-item">
                    <span class="fee-label">Peers</span>
                    <span class="fee-value" id="node-connections">—</span>
                </div>
                <div class="node-info-item">
                    <span class="fee-label">Inbound</span>
                    <span class="fee-value" id="node-in">—</span>
                </div>
                <div class="node-info-item">
                    <span class="fee-label">Outbound</span>
                    <span class="fee-value" id="node-out">—</span>
                </div>
                <div class="node-info-item">
                    <span class="fee-label">Relay Fee</span>
                    <span class="fee-value" id="node-relayfee">—</span>
                </div>
                <div class="node-info-item">
                    <span class="fee-label">Block Weight</span>
                    <span class="fee-value" id="node-blockweight">—</span>
                </div>
                <div class="node-info-item">
                    <span class="fee-label">Block TXs</span>
                    <span class="fee-value" id="node-blocktx">—</span>
                </div>
                <div class="node-info-item">
                    <span class="fee-label">Mempool TXs</span>
                    <span class="fee-value" id="node-pooledtx">—</span>
                </div>
            </div>
        </div>

        <!-- Leaderboard -->
        <div class="home-section leaderboard-section">
            <div class="pool-section-label">Leaderboard — Best Difficulties</div>
            <div class="leaderboard-table-wrapper">
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Worker</th>
                            <th>Miner</th>
                            <th>Hashrate</th>
                            <th>Best Diff</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <tr><td colspan="6" class="loading">Loading leaderboard...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pool Hashrate Chart -->
        <div class="home-section hashrate-section">
            <div class="pool-section-label">Pool Hashrate</div>
            <div class="chart-container" id="home-chart-container">
                <canvas id="home-hashrate-chart"></canvas>
            </div>
        </div>

        <!-- Bitcoin Network Hero Card -->
        <div class="home-section hero-card" id="bitcoin-hero">
        <div class="hero-header">
            <div class="hero-icon">
                <img src="/images/bitcoin.svg" alt="Bitcoin">
            </div>
            <div class="hero-title-section">
                <h2>Bitcoin Network</h2>
                <span class="live-indicator">
                    <span class="live-dot"></span>
                    mainnet connected
                </span>
            </div>
        </div>
        <div class="hero-stats">
            <div class="hero-stat primary">
                <div class="hero-stat-value" id="hero-block-height">-</div>
                <div class="hero-stat-label">Block Height</div>
            </div>
            <div class="hero-stat">
                <div class="hero-stat-value" id="hero-network-hashrate">-</div>
                <div class="hero-stat-label">Network Hashrate</div>
            </div>
            <div class="hero-stat">
                <div class="hero-stat-value" id="hero-difficulty">-</div>
                <div class="hero-stat-label">Difficulty</div>
            </div>
            <div class="hero-stat">
                <div class="hero-stat-value" id="hero-btc-price">-</div>
                <div class="hero-stat-label">BTC/USD</div>
            </div>
        </div>
        <div class="hero-details">
            <div class="hero-detail-row">
                <div class="hero-detail">
                    <span class="detail-label">Last Block Mined By</span>
                    <span class="detail-value" id="hero-last-miner">Loading...</span>
                </div>
                <div class="hero-detail">
                    <span class="detail-label">Block Time</span>
                    <span class="detail-value" id="hero-block-time">-</span>
                </div>
                <div class="hero-detail">
                    <span class="detail-label">Unconfirmed TXs</span>
                    <span class="detail-value" id="hero-mempool-txs">-</span>
                </div>
            </div>
            <div class="hero-detail-row">
                <div class="hero-detail">
                    <span class="detail-label">Mempool Size</span>
                    <span class="detail-value" id="hero-mempool">-</span>
                </div>
                <div class="hero-detail">
                    <span class="detail-label">Avg Fee</span>
                    <span class="detail-value" id="hero-avg-fee">-</span>
                </div>
                <div class="hero-detail">
                    <span class="detail-label">Next Difficulty</span>
                    <span class="detail-value" id="hero-next-diff">-</span>
                </div>
            </div>
        </div>
        <div class="recent-blocks">
            <div class="pool-section-label">Recent Blocks</div>
            <div class="blocks-list" id="recent-blocks-list">
                <div class="block-item loading">Loading recent blocks...</div>
            </div>
        </div>
        </div>

        <!-- Fee Rates & Block Reward -->
        <div class="home-section fee-rates">
            <div class="pool-section-label">Block Reward Potential</div>
            <div class="fee-grid">
                <div class="fee-item highlight">
                    <span class="fee-label">Block Subsidy</span>
                    <span class="fee-value">3.125 BTC</span>
                </div>
                <div class="fee-item highlight">
                    <span class="fee-label">Est. Fees</span>
                    <span class="fee-value" id="est-block-fees">-</span>
                </div>
                <div class="fee-item highlight">
                    <span class="fee-label">Total Reward</span>
                    <span class="fee-value" id="total-reward">-</span>
                </div>
            </div>
            <div class="pool-section-label" style="margin-top: 20px;">Fee Rates (sat/vB)</div>
            <div class="fee-grid">
                <div class="fee-item">
                    <span class="fee-label">Low</span>
                    <span class="fee-value" id="fee-low">-</span>
                </div>
                <div class="fee-item">
                    <span class="fee-label">Medium</span>
                    <span class="fee-value" id="fee-medium">-</span>
                </div>
                <div class="fee-item">
                    <span class="fee-label">High</span>
                    <span class="fee-value" id="fee-high">-</span>
                </div>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <a href="/pool" class="btn btn-primary" style="display: inline-block;">View Pool Stats</a>
            </div>
        </div>
    </div>
</div>

<script>
    let homeHashrateChart = null;

    document.addEventListener('DOMContentLoaded', function() {
        // Set stratum hostname based on how user is connecting
        const stratumHost = document.getElementById('stratum-host');
        if (stratumHost) {
            stratumHost.textContent = window.location.hostname;
        }

        loadBitcoinHeroData();
        loadPoolStats();
        loadRecentSearches();
        loadBlockRewardEstimate();
        loadHomeHashrateChart();
        loadLeaderboard();
        loadNodeInfo();

        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadBitcoinHeroData();
            loadPoolStats();
            loadBlockRewardEstimate();
            loadHomeHashrateChart();
            loadLeaderboard();
            loadNodeInfo();
        }, 30000);
    });

    async function loadPoolStats() {
        try {
            const res = await secureFetch('/api/pool');
            const data = await res.json();

            if (data.success && data.data) {
                const pool = data.data;
                updateElement('pool-hashrate', formatHashrate(pool.hashrate || 0));
                updateElement('pool-workers', pool.workers || 0);
                updateElement('pool-users', pool.users || 0);
                updateElement('pool-best-diff', formatDifficulty(pool.bestDiff || 0));
            }
        } catch (err) {
            console.error('Failed to load pool stats:', err);
        }
    }

    async function loadBlockRewardEstimate() {
        try {
            const res = await secureFetch('/api/efficiency');
            const data = await res.json();

            if (data.success && data.data) {
                const eff = data.data;
                updateElement('est-block-fees', eff.estimatedBlockFeesFormatted);
                updateElement('total-reward', eff.blockReward.toFixed(3) + ' BTC');
            }
        } catch (err) {
            console.error('Failed to load block reward estimate:', err);
        }
    }

    async function loadHomeHashrateChart() {
        try {
            const res = await secureFetch('/api/pool');
            const data = await res.json();

            if (data.success && data.data) {
                const pool = data.data;
                const chartData = [
                    { label: '7d', value: pool.hashrate7d || 0 },
                    { label: '24h', value: pool.hashrate1d || 0 },
                    { label: '6h', value: pool.hashrate6h || 0 },
                    { label: '1h', value: pool.hashrate1h || 0 },
                    { label: '15m', value: pool.hashrate15m || 0 },
                    { label: '5m', value: pool.hashrate5m || 0 },
                    { label: '1m', value: pool.hashrate1m || 0 }
                ];

                const container = document.getElementById('home-chart-container');
                const hasData = chartData.some(d => d.value > 0);

                if (!hasData) {
                    if (homeHashrateChart) {
                        homeHashrateChart.destroy();
                        homeHashrateChart = null;
                    }
                    container.innerHTML = '<div class="no-chart-data"><p>No hashrate data yet</p><p class="hint">Data appears when miners connect</p></div>';
                    return;
                }

                // Restore canvas if needed
                if (!document.getElementById('home-hashrate-chart')) {
                    container.innerHTML = '<canvas id="home-hashrate-chart"></canvas>';
                }

                // Update existing chart data instead of recreating
                if (homeHashrateChart) {
                    homeHashrateChart.data.datasets[0].data = chartData.map(d => d.value);
                    homeHashrateChart.update('none');
                } else if (typeof initHashrateChart === 'function') {
                    homeHashrateChart = initHashrateChart(chartData, 'home-hashrate-chart');
                }
            }
        } catch (err) {
            console.error('Failed to load hashrate chart:', err);
        }
    }

    async function loadNodeInfo() {
        try {
            const res = await secureFetch('/api/nodeinfo');
            const data = await res.json();
            if (!data.success || !data.data) return;
            const n = data.data;
            updateElement('node-version', n.version);
            updateElement('node-subversion', n.subversion);
            updateElement('node-connections', n.connections);
            updateElement('node-in', n.connections_in);
            updateElement('node-out', n.connections_out);
            const relaySatVb = (n.relayfee * 1e8 / 1000);
            updateElement('node-relayfee', (relaySatVb < 1 ? relaySatVb.toFixed(3) : relaySatVb.toFixed(1)) + ' sat/vB');
            updateElement('node-blockweight', n.currentblockweight ? n.currentblockweight.toLocaleString() + ' WU' : '—');
            updateElement('node-blocktx', n.currentblocktx ? n.currentblocktx.toLocaleString() : '—');
            updateElement('node-pooledtx', n.pooledtx ? n.pooledtx.toLocaleString() : '—');
        } catch (err) {
            console.error('Failed to load node info:', err);
        }
    }

    async function loadLeaderboard() {
        try {
            const res = await secureFetch('/api/leaderboard');
            const data = await res.json();

            const tbody = document.getElementById('leaderboard-body');
            if (!tbody) return;

            if (data.success && data.data && data.data.length > 0) {
                tbody.innerHTML = data.data.map((miner, index) => `
                    <tr>
                        <td class="rank-cell">#${index + 1}</td>
                        <td class="worker-cell">${miner.workerName || 'anon'}</td>
                        <td class="miner-cell">${miner.minerType || 'Unknown'}</td>
                        <td class="hashrate-cell">${miner.hashrateFormatted}</td>
                        <td class="diff-cell">${miner.bestDiffFormatted}</td>
                        <td class="status-cell"><span class="status-indicator ${miner.isOnline ? 'online' : 'offline'}" title="${miner.isOnline ? 'Online' : 'Offline'}"></span></td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="loading">No miners yet</td></tr>';
            }
        } catch (err) {
            console.error('Failed to load leaderboard:', err);
            document.getElementById('leaderboard-body').innerHTML = '<tr><td colspan="6" class="loading">Failed to load</td></tr>';
        }
    }
</script>

<style>
/* ─── Pool-section-label (matches pool stats page) ─── */
.pool-section-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: #ff931c;
    font-weight: 700;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.pool-section-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: rgba(255,147,28,0.25);
    margin-right: 52px;
}
/* Inside top-cards (no drag handle) the line can go full width */
.top-card .pool-section-label::after {
    margin-right: 0;
}

/* ─── Pool card: hashrate hero + 3-col bottom row ─── */
.pool-card {
    display: flex;
    flex-direction: column;
}
.pool-card .pool-stats-grid {
    flex: 1;
    grid-template-columns: repeat(3, 1fr);
    align-content: stretch;
}
.pool-card .pool-stat {
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.pool-card .pool-stat:first-child {
    grid-column: 1 / -1;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    padding-bottom: 18px;
    margin-bottom: 2px;
}
.pool-card #pool-hashrate {
    font-size: 2.6rem;
    font-weight: 800;
    letter-spacing: -1px;
    line-height: 1;
    color: #ff931c;
}
.pool-card .pool-stat:first-child .pool-stat-label {
    font-size: 0.72rem;
    letter-spacing: 1.5px;
    color: #888;
    margin-top: 5px;
}

/* ─── Node info grid (3×3) ─── */
.node-info-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-top: 4px;
}
.node-info-item {
    display: flex;
    flex-direction: column;
    gap: 3px;
}
@media (max-width: 600px) {
    .node-info-grid { grid-template-columns: repeat(2, 1fr); }
}

/* ─── Stratum connection block ─── */
.stratum-connect-block {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 10px;
    background: rgba(255,255,255,0.03);
    border-radius: 12px;
    padding: 12px 14px;
}
.stratum-row {
    display: flex;
    align-items: baseline;
    gap: 10px;
    font-size: 0.88rem;
}
.stratum-key {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #555;
    font-weight: 600;
    min-width: 36px;
    flex-shrink: 0;
}
.stratum-val {
    color: #c4c4c4;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    word-break: break-all;
}
.stratum-hint {
    color: #888;
}
.stratum-sep {
    color: #444;
    font-family: inherit;
    font-size: 0.75rem;
    margin: 0 6px;
}
.stratum-note {
    font-size: 0.75rem;
    color: #444;
    margin-bottom: 0;
    padding: 0 2px;
}
.stratum-port {
    margin-left: 14px;
    color: #c4c4c4;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    flex-shrink: 0;
}
.stratum-desc {
    color: #444;
    font-family: inherit;
    font-size: 0.75rem;
    margin-left: 6px;
}
</style>
